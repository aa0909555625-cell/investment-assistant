<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>台股 Top20 日報｜{{ $date }}</title>
    <style>
        body { font-family: system-ui, -apple-system; margin: 24px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 24px; }
        th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; vertical-align: top; }
        th { background: #f5f5f5; }
        h1, h2 { margin-top: 24px; }
        pre { background: #111; color: #eee; padding: 16px; white-space: pre-wrap; border-radius: 10px; }

        .card { border: 1px solid #e5e5e5; border-radius: 12px; padding: 14px; margin-bottom: 16px; }
        .muted { color: #666; font-size: 13px; }

        /* Gauge */
        .gauge-wrap { margin-top: 10px; }
        .gauge-bar {
            position: relative;
            height: 16px;
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid #ddd;
            background: linear-gradient(90deg,
                #d32f2f 0%,
                #d32f2f 39%,
                #f9a825 39%,
                #f9a825 59%,
                #43a047 59%,
                #43a047 74%,
                #1e88e5 74%,
                #1e88e5 100%
            );
        }
        .gauge-marker {
            position: absolute;
            top: -6px;
            width: 2px;
            height: 28px;
            background: #111;
        }
        .gauge-labels { display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 6px; }
        .pill {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid #ddd;
            background: #fafafa;
        }
        .zone-buy { border-color: #1e88e5; }
        .zone-buy-lite { border-color: #43a047; }
        .zone-hold { border-color: #f9a825; }
        .zone-sell { border-color: #d32f2f; }

        .warn { color: #b00020; font-size: 12px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
        @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<h1>台股 Top20 日報</h1>
<p class="muted">日期：<strong>{{ $date }}</strong>（v1 規則型：依單日 OHLC/量能做相對排名；非投資建議）</p>

<div class="card">
    <h2 style="margin-top:0;">分析評估（總分）</h2>
    <div class="grid">
        @php
            $top1Pct = max(0, min(100, (int)$top1_score));
            $avgPct  = max(0, min(100, (int)$avg_score));
        @endphp

        <div>
            <div class="muted">Top1（第一名）總分</div>
            <div style="display:flex; gap:10px; align-items:center; margin-top:6px;">
                <div style="font-size:22px;"><strong>{{ $top1_score }}</strong>/100</div>
                <span class="pill zone-{{ $top1_action['zone'] }}">{{ $top1_action['label'] }}</span>
            </div>

            <div class="gauge-wrap">
                <div class="gauge-bar">
                    <div class="gauge-marker" style="left: calc({{ $top1Pct }}% - 1px);"></div>
                </div>
                <div class="gauge-labels">
                    <span>0</span><span>40</span><span>60</span><span>75</span><span>100</span>
                </div>
            </div>
        </div>

        <div>
            <div class="muted">Top20 平均總分</div>
            <div style="display:flex; gap:10px; align-items:center; margin-top:6px;">
                <div style="font-size:22px;"><strong>{{ $avg_score }}</strong>/100</div>
                <span class="pill zone-{{ $avg_action['zone'] }}">{{ $avg_action['label'] }}</span>
            </div>

            <div class="gauge-wrap">
                <div class="gauge-bar">
                    <div class="gauge-marker" style="left: calc({{ $avgPct }}% - 1px);"></div>
                </div>
                <div class="gauge-labels">
                    <span>0</span><span>40</span><span>60</span><span>75</span><span>100</span>
                </div>
            </div>
        </div>
    </div>

    <div class="muted" style="margin-top:12px;">
        分數區間解讀：0–39（偏賣出/避開）｜40–59（觀望/持有）｜60–74（小額試單）｜75–100（偏買進/加碼）
    </div>
</div>

<h2>Top 20 股票</h2>
<table>
    <thead>
        <tr>
            <th>#</th>
            <th>代號</th>
            <th>名稱</th>
            <th>分類</th>
            <th>總分</th>
            <th>警示</th>
        </tr>
    </thead>
    <tbody>
        @foreach ($top20 as $i => $row)
        <tr>
            <td>{{ $i + 1 }}</td>
            <td>{{ $row['symbol'] }}</td>
            <td>{{ $row['name'] }}</td>
            <td>{{ $row['bucket'] }}</td>
            <td><strong>{{ $row['score_total'] }}</strong></td>
            <td class="warn">
                {{ isset($row['warnings']) ? implode('、', $row['warnings']) : '' }}
            </td>
        </tr>
        @endforeach
    </tbody>
</table>

<h2>系統解讀（v1 規則型）</h2>
<pre>{{ $ai_comment }}</pre>

</body>
</html>