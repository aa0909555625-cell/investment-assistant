#Requires -Version 5.1
[CmdletBinding()]
param(
  [string]$Date = "",
  [int]$Capital = 300000,
  [int]$Top = 4000,
  [string]$OutDir = ".\reports",
  [switch]$Open,
  [switch]$ListDates
)

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

function HtmlEncode([string]$s){
  if($null -eq $s){ return "" }
  return [System.Net.WebUtility]::HtmlEncode($s)
}
function FormatPct($x){
  if($null -eq $x){ return "" }
  try { return ("{0:N2}%" -f ([double]$x)) } catch { return "$x" }
}
function FormatNum($x){
  if($null -eq $x){ return "" }
  try { return ("{0:N0}" -f ([double]$x)) } catch { return "$x" }
}
function GetProp([object]$o, [string]$name, $default = $null){
  if($null -eq $o){ return $default }
  $p = $o.PSObject.Properties[$name]
  if($null -ne $p){ return $p.Value }
  return $default
}
function GetFirstProp([object]$o, [string[]]$names, $default = $null){
  foreach($n in $names){
    $v = GetProp $o $n $null
    if($null -ne $v -and ("$v").Trim().Length -gt 0){ return $v }
  }
  return $default
}

# ---- outdir ----
if(!(Test-Path $OutDir)){
  New-Item -ItemType Directory -Force -Path $OutDir | Out-Null
}
$OutDirFull = (Resolve-Path $OutDir).Path

if($ListDates){
  Get-ChildItem -Path $OutDirFull -Filter "market_snapshot_*.json" -File |
    ForEach-Object {
      if($_.Name -match '^market_snapshot_(\d{4}-\d{2}-\d{2})\.json$'){ $matches[1] }
    } | Sort-Object
  exit 0
}

if([string]::IsNullOrWhiteSpace($Date)){
  $latest = Get-ChildItem -Path $OutDirFull -Filter "market_snapshot_*.json" -File |
    Sort-Object LastWriteTime -Descending | Select-Object -First 1
  if($null -eq $latest){ throw "No market_snapshot_*.json found in $OutDirFull" }
  if($latest.Name -match '^market_snapshot_(\d{4}-\d{2}-\d{2})\.json$'){ $Date = $matches[1] }
  else { throw "Cannot parse date from $($latest.Name)" }
}

$snapPath = Join-Path $OutDirFull ("market_snapshot_{0}.json" -f $Date)
$idxPath  = Join-Path $OutDirFull ("indices_{0}.json" -f $Date)
$outHtml  = Join-Path $OutDirFull ("dashboard_{0}.html" -f $Date)

if(!(Test-Path $snapPath)){ throw "Snapshot json not found: $snapPath" }

$snap = (Get-Content $snapPath -Raw -Encoding UTF8) | ConvertFrom-Json

$idx = $null
if(Test-Path $idxPath){
  try { $idx = (Get-Content $idxPath -Raw -Encoding UTF8) | ConvertFrom-Json } catch { $idx = $null }
}

# ---- extract summary (SAFE under StrictMode) ----
$band = ""
$strategy = ""
$suggestedPos = ""
$hotZones = @()
$weakZones = @()

$tape = GetProp $snap "tape_summary" $null
if($null -ne $tape){
  $band = HtmlEncode (GetProp $tape "band" "")
  $strategy = HtmlEncode (GetProp $tape "strategy" "")

  $sp = GetProp $tape "suggested_position" $null
  if($null -ne $sp){
    try { $suggestedPos = ("{0:P0}" -f ([double]$sp)) } catch { $suggestedPos = "$sp" }
  }

  $hz = GetProp $tape "hot_zones" $null
  if($null -ne $hz){ $hotZones = @($hz) }

  $wz = GetProp $tape "weak_zones" $null
  if($null -ne $wz){ $weakZones = @($wz) }
}

# ---- indices block (robust props) ----
$indicesBlock = ""
if($null -ne $idx){
  $rows = @()

  $levelKeys = @("level","close","value","last","price","index_level","idx_level")
  $chgKeys   = @("change_percent","chg_percent","changePct","pct_change","change_pct","change")
  $nameKeys  = @("name","symbol","index","id")

  foreach($p in $idx.PSObject.Properties){
    if($p.Name -in @("source","fetched_at")){ continue }
    $it = $p.Value
    if($null -eq $it){ continue }

    $nameRaw  = GetFirstProp $it $nameKeys $p.Name
    $levelRaw = GetFirstProp $it $levelKeys (GetProp $it "last" "")
    $chgRaw   = GetFirstProp $it $chgKeys ""

    $name  = HtmlEncode ("$nameRaw")
    $level = HtmlEncode ("$levelRaw")
    $chg   = HtmlEncode (FormatPct $chgRaw)

    $rows += "<tr><td>$name</td><td class='num'>$level</td><td class='num'>$chg</td></tr>"
  }

  if($rows.Count -gt 0){
    $indicesBlock = @"
<div class="card">
  <div class="card-h">指數</div>
  <table>
    <thead><tr><th>名稱</th><th class="num">點位</th><th class="num">漲跌%</th></tr></thead>
    <tbody>
      $(($rows -join "`n      "))
    </tbody>
  </table>
</div>
"@
  }
}

# ---- chips ----
$hotHtml = ""
if($hotZones.Count -gt 0){
  $hotHtml = "<div class='chips'>" + (($hotZones | ForEach-Object { "<span class='chip hot'>" + (HtmlEncode "$_") + "</span>" }) -join "") + "</div>"
}
$weakHtml = ""
if($weakZones.Count -gt 0){
  $weakHtml = "<div class='chips'>" + (($weakZones | ForEach-Object { "<span class='chip weak'>" + (HtmlEncode "$_") + "</span>" }) -join "") + "</div>"
}

# ---- KPI (SAFE under StrictMode) ----
$kpiBlock = ""
$kpi = GetProp $snap "kpi" $null
if($null -ne $kpi){
  $cards = @()
  foreach($p in $kpi.PSObject.Properties){
    $k = HtmlEncode ($p.Name)
    $v = HtmlEncode ("$($p.Value)")
    $cards += "<div class='kpi'><div class='k'>$k</div><div class='v'>$v</div></div>"
  }
  if($cards.Count -gt 0){
    $kpiBlock = "<div class='card'><div class='card-h'>KPI</div><div class='kpis'>" + ($cards -join "") + "</div></div>"
  }
}

# ---- Top picks (SAFE under StrictMode) ----
$topBlock = ""
$topPicks = GetProp $snap "top_picks" $null
if($null -ne $topPicks){
  $trs = @()
  foreach($it in @($topPicks)){
    if($null -eq $it){ continue }
    $code   = HtmlEncode (GetProp $it "code" "")
    $name   = HtmlEncode (GetProp $it "name" "")
    $sector = HtmlEncode (GetProp $it "sector" "")
    $chg    = HtmlEncode (FormatPct (GetProp $it "change_percent" $null))
    $score  = HtmlEncode ("" + (GetProp $it 'total_score' ""))
    $trs += "<tr><td>$code</td><td>$name</td><td>$sector</td><td class='num'>$chg</td><td class='num'>$score</td></tr>"
  }
  if($trs.Count -gt 0){
    $topBlock = @"
<div class="card">
  <div class="card-h">Top Picks（Top=$(HtmlEncode (FormatNum $Top))）</div>
  <table>
    <thead><tr><th>代碼</th><th>名稱</th><th>類股</th><th class="num">漲跌%</th><th class="num">總分</th></tr></thead>
    <tbody>
      $(($trs -join "`n      "))
    </tbody>
  </table>
</div>
"@
  }
}

# ---- HTML template ----
$template = @"
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Investment Assistant Dashboard :: __DATE__</title>
  <style>
    body{font-family:Segoe UI,Microsoft JhengHei,Arial,sans-serif;background:#0b1020;color:#e8eefc;margin:0;padding:18px}
    .wrap{max-width:1200px;margin:0 auto}
    .topbar{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;margin-bottom:14px}
    .title{font-size:20px;font-weight:700}
    .sub{opacity:.75;font-size:13px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .card{background:#111a2d;border:1px solid #22304f;border-radius:14px;padding:12px 12px 10px 12px;box-shadow:0 6px 18px rgba(0,0,0,.22)}
    .card-h{font-weight:700;margin-bottom:8px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #22304f;padding:8px 6px;font-size:13px}
    th{opacity:.85;text-align:left}
    td.num,th.num{text-align:right}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-block;padding:6px 10px;border-radius:999px;font-size:13px;border:1px solid #2a3a60}
    .chip.hot{background:rgba(255,90,90,.12)}
    .chip.weak{background:rgba(120,170,255,.10)}
    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media (max-width: 900px){ .kpis{grid-template-columns:repeat(2,minmax(0,1fr))} }
    .kpi{background:#0e1730;border:1px solid #22304f;border-radius:12px;padding:10px}
    .kpi .k{opacity:.75;font-size:12px}
    .kpi .v{font-size:16px;font-weight:700;margin-top:4px}
    .band{font-weight:800}
  </style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div>
      <div class="title">市場盤口總覽 :: __DATE__</div>
      <div class="sub">Capital=__CAPITAL__ ｜ Top=__TOP__</div>
    </div>
    <div style="margin-left:auto">
      <div class="sub">Band：<span class="band">__BAND__</span></div>
      <div class="sub">建議持倉：__SUGGESTED_POS__</div>
    </div>
  </div>

  <div class="grid">
    __INDICES_BLOCK__
    __KPI_BLOCK__

    <div class="card">
      <div class="card-h">Hot Zones</div>
      __HOT_ZONES__
    </div>

    <div class="card">
      <div class="card-h">Weak Zones</div>
      __WEAK_ZONES__
    </div>

    <div class="card" style="grid-column:1 / -1">
      <div class="card-h">盤口摘要</div>
      <div>__STRATEGY__</div>
    </div>

    <div style="grid-column:1 / -1">
      __TOP_BLOCK__
    </div>
  </div>
</div>
</body>
</html>
"@

$html =
  $template.
    Replace("__DATE__", (HtmlEncode $Date)).
    Replace("__CAPITAL__", (HtmlEncode (FormatNum $Capital))).
    Replace("__TOP__", (HtmlEncode (FormatNum $Top))).
    Replace("__BAND__", $band).
    Replace("__SUGGESTED_POS__", (HtmlEncode $suggestedPos)).
    Replace("__STRATEGY__", $strategy).
    Replace("__HOT_ZONES__", $hotHtml).
    Replace("__WEAK_ZONES__", $weakHtml).
    Replace("__INDICES_BLOCK__", $indicesBlock).
    Replace("__KPI_BLOCK__", $kpiBlock).
    Replace("__TOP_BLOCK__", $topBlock)

# write UTF-8 no BOM, CRLF
$utf8NoBom = New-Object System.Text.UTF8Encoding($false)
[System.IO.File]::WriteAllText($outHtml, $html.Replace("`r`n","`n").Replace("`n","`r`n"), $utf8NoBom)

Write-Host ("OK: wrote HTML -> {0}" -f $outHtml) -ForegroundColor Green
if($Open){ Start-Process $outHtml | Out-Null }
exit 0